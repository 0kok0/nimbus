language: go

# https://docs.travis-ci.com/user/caching/
cache:
  directories:
    - rocksdbCache
    - vendor/Nim/bin
    - jsonTestsCache

git:
  # when multiple CI builds are queued, the tested commit needs to be in the last X commits cloned with "--depth X"
  depth: 10
  # disable LFS file downloading during regular cloning
  lfs_skip_smudge: true

go:
  - "1.12.x"

matrix:
  include:
    - os: linux
      sudo: required
      before_install:
        - export LD_LIBRARY_PATH="$LD_LIBRARY_PATH:/usr/local/lib"
    - os: osx
      before_install:
        - launchctl setenv LIBRARY_PATH /usr/local/lib # for RocksDB

install:
  # build our own rocksdb to test with a fixed version that we think works
  - ./build_rocksdb.sh rocksdbCache

  # LFS test fixtures
  - cd vendor/nim-beacon-chain; scripts/process_lfs.sh ../../jsonTestsCache; cd ../..

script:
  - set -e # fail fast
  - make -j2
  - ./build/nimbus --help
  - make -j2 test test-reproducibility
  - make -C vendor/nim-beacon-chain DISABLE_LFS_SCRIPT=1 -j2 test
  - make go-checks

